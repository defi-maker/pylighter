# 网格交易策略指南

## 概述

网格交易策略是一种自动化交易策略，通过在价格区间内设置买卖网格来获取震荡行情中的利润。本实现基于参考的 Binance 网格策略，完全适配 Lighter Protocol。

## 策略特点

### 核心逻辑
- **双向持仓**: 同时运行多头和空头策略
- **网格间距**: 0.1% 的固定网格间距
- **实时价格**: WebSocket 实时价格更新（与参考 Binance 策略一致）
- **动态调整**: 基于价格变动自动调整网格位置
- **风险控制**: 持仓阈值和限制机制

### 参数配置

在 `grid_strategy_ton.py` 中可调整的参数：

```python
COIN_NAME = "TON"              # 交易币种
GRID_SPACING = 0.001           # 网格间距 (0.1%)
LEVERAGE = 5                   # 杠杆倍数 (TON最低5x)
POSITION_THRESHOLD = 50        # 锁仓阈值
POSITION_LIMIT = 20            # 持仓数量阈值
UPDATE_INTERVAL = 5            # 价格更新间隔(秒)
```

## 使用方法

### 1. 模拟测试（强烈推荐先运行）
```bash
uv run grid_strategy_ton.py --dry-run
```

模拟测试特点：
- ✅ 使用真实 WebSocket 价格数据
- ✅ 完整策略逻辑测试
- ✅ 显示实际订单参数
- ✅ 无真实资金风险

### 2. 实盘交易
```bash
uv run grid_strategy_ton.py
```

**启动前确认：**
- 账户中有足够的 TON 或 USDC 余额
- WebSocket 连接稳定
- 已理解风险并接受可能的损失

### 3. 其他币种测试
```bash
# 测试 XRP
uv run grid_strategy_ton.py --symbol XRP --dry-run

# 实际交易 XRP  
uv run grid_strategy_ton.py --symbol XRP
```

## 策略逻辑详解

### 初始化阶段
1. **获取市场数据**: 价格、精度、最小交易量等
2. **启动 WebSocket**: 建立实时价格订阅连接
3. **计算订单量**: 基于 $10 最小交易额计算 TON 数量
4. **设置网格**: 根据当前价格设置初始网格位置

### 运行阶段

#### 无持仓时
- **多头**: 在 bid 价格下买单
- **空头**: 在 ask 价格下卖单

#### 有持仓时
- **止盈单**: 在网格上边界挂反向订单
- **加仓单**: 在网格下边界挂同方向订单
- **网格调整**: 价格移动时重新计算网格位置

#### 风险控制
```python
# 当持仓超过阈值时
if position > POSITION_THRESHOLD:
    # 切换到保守模式，只挂止盈单
    
if position > POSITION_LIMIT:
    # 双倍订单量，加速平仓
```

## 盈利机制

### 震荡行情
1. 价格在网格内震荡
2. 低买高卖，赚取价差
3. 双向操作，提高资金利用率

### 示例场景
```
TON 价格: $3.15
网格间距: 0.1%

多头网格:
- 买入: $3.1468 (3.2 TON)
- 卖出: $3.1532 (3.2 TON)
- 预期利润: ~$0.64 每轮

空头网格:
- 卖出: $3.1532 (-3.2 TON)  
- 买入: $3.1468 (-3.2 TON)
- 预期利润: ~$0.64 每轮
```

## 风险管理

### 主要风险
1. **趋势风险**: 单边行情可能导致浮亏
2. **保证金风险**: 杠杆交易需要足够保证金
3. **技术风险**: 网络中断或系统故障

### 风险缓解
1. **持仓限制**: 自动控制持仓规模
2. **分散风险**: 双向持仓对冲部分风险
3. **低杠杆**: 使用最低5倍杠杆
4. **监控机制**: 实时监控持仓和订单状态

## 性能优化

### 数据更新
- **WebSocket 优先**: 使用实时 WebSocket 价格更新
- **REST API 备用**: WebSocket 失败时自动切换到轮询模式
- **重连机制**: 自动重连断开的 WebSocket 连接

### 订单管理
- **批量取消**: 避免频繁的单独取消操作
- **精度优化**: 使用正确的价格和数量精度
- **网格更新**: 只在必要时更新网格位置

### 资金效率
- **最小交易额**: 使用 $10 最小标准
- **动态数量**: 根据实时价格计算精确数量
- **杠杆利用**: 合理使用5倍杠杆提高资金效率

## 监控和调试

### 日志输出
策略运行时会输出详细日志：
```
INFO - 📡 WebSocket mode enabled - real-time price updates
INFO - 🌐 Starting WebSocket connection...
INFO - Price: $3.153240 (Bid: $3.152470, Ask: $3.154010)
INFO - Position sync: Long=15.0, Short=0.0
INFO - Placing long take profit and additional buy orders
```

### 日志文件
所有日志保存在 `log/grid_ton_lighter.log`

### 关键指标监控
- 当前价格和网格位置
- 持仓数量和盈亏状态
- 订单执行成功率
- 网格调整频率

## 常见问题

### Q: 为什么选择 TON 而不是其他币种？
A: TON 能够以接近 $10 的最小交易额进行交易，相比其他一些币种成本更低，更适合网格策略。

### Q: 网格间距可以调整吗？
A: 可以修改 `GRID_SPACING` 参数，但建议先在模拟环境测试效果。

### Q: 如何停止策略？
A: 使用 Ctrl+C 安全停止，策略会自动清理资源。

### Q: 策略适合所有行情吗？
A: 网格策略最适合震荡行情，强趋势行情可能产生浮亏。

## 免责声明

- 网格交易存在亏损风险，特别是在趋势行情中
- 杠杆交易会放大风险和收益
- 请只投入可承受损失的资金
- 建议先用小额资金测试策略效果